# PocketFit 项目开发日志

## 项目概述
PocketFit 是一个基于 Flutter 的运动健康应用，通过手机传感器检测久坐行为，并通过互动挑战引导用户保持活力。

---

## 开发进度

### ✅ 第一步：项目基础架构搭建
**完成时间：** 2025-11-12

#### 完成内容：
1. **项目初始化**
   - 创建 Flutter 项目
   - 配置项目名称和基本信息
   - 解决 Gradle 和 Java 版本兼容性问题

2. **UI 框架搭建**
   - 创建首页 (`HomePage`)
     - 欢迎区域（根据时间显示问候语）
     - 今日统计卡片（活动时间、久坐时间、完成活动、今日目标）
     - 快速操作按钮（开始活动、活动历史）
     - 核心功能介绍卡片
   - 创建统计页面 (`StatisticsPage`)
     - 时间段选择器（日/周/月）
     - 数据概览卡片
     - 图表占位符
     - 活动记录列表
   - 创建设置页面 (`SettingsPage`)
     - 通知设置（启用通知、振动反馈、声音提示）
     - 活动设置（提醒间隔、检测灵敏度）
     - 关于信息

3. **导航系统**
   - 实现底部导航栏 (`MainNavigation`)
   - 三个主要页面切换（首页、统计、设置）
   - 使用 IndexedStack 保持页面状态

4. **项目目录结构**
   ```
   lib/
   ├── main.dart
   ├── pages/
   │   ├── home_page.dart
   │   ├── statistics_page.dart
   │   ├── settings_page.dart
   │   └── main_navigation.dart
   ├── models/          # 数据模型（待添加）
   ├── services/        # 业务逻辑服务（待添加）
   ├── utils/           # 工具类（待添加）
   └── widgets/         # 可复用组件（待添加）
   ```

5. **Android 权限配置**
   - 传感器权限（BODY_SENSORS, HIGH_SAMPLING_RATE_SENSORS）
   - 振动权限（VIBRATE）
   - 通知权限（POST_NOTIFICATIONS）
   - 前台服务权限（FOREGROUND_SERVICE, FOREGROUND_SERVICE_HEALTH）
   - 唤醒锁权限（WAKE_LOCK）

6. **主题和样式**
   - Material 3 设计系统
   - 蓝色主题色
   - 渐变背景（蓝色到紫色）
   - 统一的卡片样式和阴影效果
   - 响应式布局

#### 技术栈：
- Flutter 3.22.2
- Dart 3.4.3
- Material Design 3
- Gradle 8.7
- Android Gradle Plugin 8.3.0
- Kotlin 1.9.22

#### 遇到的问题及解决：
1. **Gradle 版本兼容性问题**
   - 问题：Java 21 与 Gradle 7.6.3 不兼容
   - 解决：升级 Gradle 到 8.7，AGP 到 8.3.0，Kotlin 到 1.9.22

2. **JVM Target 问题**
   - 问题：Kotlin 不支持 JVM target 21
   - 解决：设置 Java 和 Kotlin 的 target 为 17

---

### ✅ 第二步：传感器数据采集模块
**开始时间：** 2025-11-12
**完成时间：** 2025-11-12

#### 完成内容：

1. **集成 sensors_plus 插件**
   - 使用 `flutter pub add sensors_plus` 安装依赖
   - 版本：sensors_plus 7.0.0
   - 支持加速度计和陀螺仪数据读取

2. **创建数据模型** (`lib/models/sensor_data.dart`)
   - `SensorData` 类：存储传感器数据（时间戳、x/y/z 轴、类型）
   - `SensorType` 枚举：区分加速度计和陀螺仪
   - `MotionState` 枚举：运动状态（静止/运动中/未知）
   - `MotionStatistics` 类：运动统计数据（方差、均值、标准差）
   - 实现向量模计算功能

3. **创建传感器服务类** (`lib/services/sensor_service.dart`)
   - 单例模式设计，全局唯一实例
   - 实现传感器数据监听和采集
   - 功能特性：
     - 加速度计数据流监听
     - 陀螺仪数据流监听
     - 采样频率控制（100ms 间隔）
     - 数据缓冲区管理（滑动窗口，最多 100 个数据点）
     - 实时运动状态分析
     - 统计数据计算（均值、方差、标准差）
   - 服务控制：
     - `start()` - 启动传感器监听
     - `stop()` - 停止传感器监听
     - `clearBuffers()` - 清空缓冲区
     - `dispose()` - 释放资源

4. **数据缓存和时间窗口处理**
   - 使用 `Queue` 实现固定大小的滑动窗口
   - 缓冲区大小：100 个数据点
   - 采样间隔：100ms
   - 自动移除旧数据，保持窗口大小恒定
   - 支持实时数据流广播

5. **运动状态检测算法（初步版本）**
   - 基于加速度计数据的方差分析
   - 阈值设定：
     - 静止阈值：方差 < 2.0
     - 运动阈值：方差 > 10.0
     - 中间状态：未知
   - 实时计算并广播运动状态

6. **创建传感器测试页面** (`lib/pages/sensor_test_page.dart`)
   - 实时显示传感器数据
   - 功能模块：
     - 运动状态卡片（显示当前状态、方差、均值、标准差）
     - 加速度计数据卡片（X/Y/Z 轴、向量模、历史曲线）
     - 陀螺仪数据卡片（X/Y/Z 轴、向量模、历史曲线）
     - 缓冲区信息卡片（缓冲区大小、采样间隔）
   - 可视化特性：
     - 实时数据更新
     - 简单的历史数据曲线图
     - 状态颜色指示（绿色=静止，橙色=运动，灰色=未知）
     - 刷新按钮清空数据
   - 从首页"智能检测"卡片可进入测试页面

#### 技术实现：

**数据流架构：**
```
传感器硬件 → sensors_plus 插件 → SensorService
    ↓
数据采样（100ms 间隔）
    ↓
数据缓冲区（Queue，100个数据点）
    ↓
统计分析（方差、均值、标准差）
    ↓
运动状态判断
    ↓
Stream 广播 → UI 更新
```

**核心算法：**
- 向量模计算：`magnitude = sqrt(x² + y² + z²)`
- 方差计算：`variance = Σ(xi - mean)² / n`
- 标准差：`stdDev = sqrt(variance)`

#### 测试结果：
- ✅ 传感器数据成功采集
- ✅ 实时数据流正常工作
- ✅ 缓冲区管理正确
- ✅ 运动状态检测基本可用
- ✅ UI 实时更新流畅
- ⚠️ 阈值需要根据实际使用场景调整

#### 遇到的问题及解决：
1. **采样频率过高导致性能问题**
   - 问题：传感器原始采样率很高（通常 100Hz+）
   - 解决：添加采样间隔控制，限制为 100ms 一次

2. **数据缓冲区无限增长**
   - 问题：持续采集会导致内存占用增加
   - 解决：使用固定大小的 Queue，自动移除旧数据

3. **UI 更新频率过高**
   - 问题：每次数据更新都触发 setState 导致卡顿
   - 解决：使用 Stream 和 StreamBuilder 优化更新机制

---

### 🔄 第三步：静止状态检测算法
**状态：** 待开始

#### 计划内容：
1. 优化运动方差计算算法
2. 设定更精确的静止/运动状态判断阈值
3. 添加时间窗口滑动检测（如30分钟无活动）
4. 实现久坐时长统计
5. 测试不同场景下的检测准确率（坐着、站着、走路、跑步等）
6. 添加状态变化事件通知

---

### 📋 待完成步骤

- [x] 第一步：项目基础架构搭建
- [x] 第二步：传感器数据采集模块
- [ ] 第三步：静止状态检测算法
- [ ] 第四步：活动提醒系统
- [ ] 第五步：互动运动识别
- [ ] 第六步：多模态反馈系统
- [ ] 第七步：数据存储和统计
- [ ] 第八步：用户体验优化
- [ ] 第九步：游戏化元素（可选）
- [ ] 第十步：高级功能扩展（未来）

---

## 备注
- 项目采用渐进式开发方式，每完成一步都会进行测试验证
- 所有代码遵循 Flutter 最佳实践和 Material Design 规范
- 注重代码可维护性和可扩展性

